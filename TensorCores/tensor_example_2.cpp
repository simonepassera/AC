/* Example of using tensor core with WMMA functions for D = A*B+C and 16x16x16 */

#include<vector>
#include<iostream>
#include<random>
#include<stdlib.h>
#include<mma.h>

using namespace nvcuda;

inline void gpuAssert(cudaError_t code, const char *file, int line)
{
    if (code != cudaSuccess) {
        std::cerr << "GPUassert code: " << cudaGetErrorString(code) << ", file: " << file << ", line: " << line << std::endl;
        exit(code);
    }
}

#define gpuErrchk(ans) { gpuAssert((ans), __FILE__, __LINE__); }

__global__ void tensor_16x16_kernel(half *A, half *B, float *C, float *D)
{
    int id = (blockIdx.x * blockDim.x) + threadIdx.x;
    if (id < 32) {
        // create fragments
        wmma::fragment<wmma::matrix_a, 16, 16, 16, half, wmma::row_major> A_frag;
        wmma::fragment<wmma::matrix_b, 16, 16, 16, half, wmma::row_major> B_frag;
        wmma::fragment<wmma::accumulator, 16, 16, 16, float> C_frag;
        wmma::fragment<wmma::accumulator, 16, 16, 16, float> D_frag;

        // load fragments
        wmma::load_matrix_sync(A_frag, A, 16);
        wmma::load_matrix_sync(B_frag, B, 16);
        wmma::load_matrix_sync(C_frag, C, 16, wmma::mem_row_major);

        // perform the matrix multiplication
        wmma::mma_sync(D_frag, A_frag, B_frag, C_frag);

        // store the output
        wmma::store_matrix_sync(D, D_frag, 16, wmma::mem_row_major);
    }
}

int main(int argc, char **argv)
{
    // allocation and initialization of the host vectors
    auto host_A = std::vector<half>{ // A is 16x16
        -0.029,  2.105, -1.886,  0.295, -0.114,  0.181,  0.889,  0.996,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,
        -0.045, -0.544,  0.583, -0.853, -1.933, -1.307, -0.455, -0.192,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,
        -0.971, -1.172, -0.597, -2.666, -0.322,  1.346, -0.027,  0.411,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,
         0.436, -1.798,  0.362, -0.899,  0.176, -0.616, -0.230,  0.486,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,
        -0.304, -0.406, -0.001, -1.545,  1.060,  1.139,  1.473,  0.522,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,
        -1.135, -0.768,  1.767,  1.431, -0.728,  0.155, -1.767, -1.696,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,
         1.407, -1.319,  0.601,  1.388, -1.371, -0.532,  0.004,  1.250,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,
         0.850, -0.154, -1.392,  0.170, -1.029,  1.483,  0.023,  0.225,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,
        -0.185,  1.259,  1.232,  0.600,  0.099,  0.080,  1.711, -1.145,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,
         0.010, -1.740, -1.447, -0.055,  0.306,  0.794,  0.611, -1.414,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,
         1.035, -0.164,  0.523, -1.527, -0.028,  1.389,  0.404,  1.185,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,
        -0.434, -0.201, -0.580, -1.135,  1.136, -1.856, -0.687, -0.285,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,
         0.145, -1.240,  0.017,  0.566, -0.148, -0.640, -1.786,  0.334,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,
         0.071, -0.002, -1.080, -0.769,  1.097, -0.233, -0.210,  1.345,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,
        -1.869,  0.477,  1.172,  0.433,  2.041, -0.187,  0.025, -0.158,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,
        -0.587, -0.525, -1.792, -0.261,  1.541, -0.011,  0.527, -0.814,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234
    };
    auto host_B = std::vector<half>{ // B is 16x16
        0.151, -0.551,  0.251,  0.594, -0.380,  0.119,  0.035, -0.814,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,
       -0.008, -0.017,  0.356,  0.609, -0.129, -0.311, -0.193, -0.213,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,
       -0.678,  0.153,  0.628,  0.265,  0.272,  0.657, -0.238, -0.130,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,
        0.582, -0.177, -0.392,  0.219,  0.246, -0.036,  0.132,  0.200,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,
       -0.084,  0.004,  0.251,  0.742, -0.296, -0.047,  0.000,  0.235,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,
        0.087,  0.094,  0.147, -0.448, -0.046,  0.322, -0.108, -0.011,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,
       -0.057, -0.006, -0.546, -0.200,  0.568,  0.115,  0.095, -0.390,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,
        0.053, -0.003,  0.045, -0.101,  0.494, -0.305,  0.722,  0.349,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,
        0.151, -0.551,  0.251,  0.594, -0.380,  0.119,  0.035, -0.814,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,
       -0.008, -0.017,  0.356,  0.609, -0.129, -0.311, -0.193, -0.213,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,
       -0.678,  0.153,  0.628,  0.265,  0.272,  0.657, -0.238, -0.130,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,
        0.582, -0.177, -0.392,  0.219,  0.246, -0.036,  0.132,  0.200,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,
       -0.084,  0.004,  0.251,  0.742, -0.296, -0.047,  0.000,  0.235,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,
        0.087,  0.094,  0.147, -0.448, -0.046,  0.322, -0.108, -0.011,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,
       -0.057, -0.006, -0.546, -0.200,  0.568,  0.115,  0.095, -0.390,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,
        0.053, -0.003,  0.045, -0.101,  0.494, -0.305,  0.722,  0.349,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234
    };
    auto host_C = std::vector<float>{ // C is 16x16
        -0.077, -0.377,  0.367,  0.196,  0.196, -0.492,  0.076,  0.061,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,
       -0.080, -0.575,  0.582, -0.312,  1.398, -0.974,  0.702,  0.149,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,
        0.286,  1.697,  1.222,  1.819,  0.535,  0.485,  0.400,  1.442,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,
       -0.965,  1.804, -2.018, -0.115,  0.445, -0.073, -0.926,  2.370,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,
       -0.492,  1.280, -0.754,  0.718, -0.559, -0.818, -2.285, -0.152,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,
       -1.667,  0.659, -0.357,  0.883,  0.643, -0.061,  1.028, -0.280,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,
        1.952, -1.909, -1.774,  0.315, -0.300,  0.558, -0.425,  0.237,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,
       -0.624, -2.727, -0.988, -1.164,  1.633,  1.442,  1.539,  0.159,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,
       -0.755, -1.314, -0.414,  1.452, -0.664, -0.282, -0.051,  1.162,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,
       -0.232, -1.735, -1.378, -1.172, -1.932,  0.403, -0.002,  0.282,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,
        0.904,  1.210,  0.532, -0.018, -0.609,  0.441,  1.047, -0.649,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,
       -0.896,  0.251, -0.363, -1.750,  1.364,  0.332,  0.552,  0.080,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,
       -0.788, -0.291,  1.004, -0.037, -0.064,  1.263, -0.552,  0.701,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,  0.789,  0.012,
        0.542, -1.023,  0.520, -1.334,  2.252,  0.453,  0.675, -0.316,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,  0.123,  0.456,
        0.404, -1.913,  0.261,  1.448,  0.687,  2.093, -0.149,  0.346,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234,  0.567,  0.890,
       -0.537, -0.520, -0.283,  1.143,  0.350, -0.357, -1.604,  0.260,  0.123,  0.456,  0.789,  0.012,  0.345,  0.678,  0.901,  0.234
    };
    auto host_D = std::vector<float>(16*16, 0.f); // D is 16x8

    // allocate GPU arrays
    cudaSetDevice(0); // set the working device
    half *dev_A;
    half *dev_B;
    float *dev_C;
    float *dev_D;
    gpuErrchk(cudaMalloc((void**) &dev_A, sizeof(half) * 16 * 16));
    gpuErrchk(cudaMalloc((void**) &dev_B, sizeof(half) * 16 * 16));
    gpuErrchk(cudaMalloc((void**) &dev_C, sizeof(float) * 16 * 16));
    gpuErrchk(cudaMalloc((void**) &dev_D, sizeof(float) * 16 * 16));

    // copy data to GPU memory
    gpuErrchk(cudaMemcpy(dev_A, host_A.data(), sizeof(half) * 16 * 16, cudaMemcpyHostToDevice));
    gpuErrchk(cudaMemcpy(dev_B, host_B.data(), sizeof(half) * 16 * 16, cudaMemcpyHostToDevice));
    gpuErrchk(cudaMemcpy(dev_C, host_C.data(), sizeof(float) * 16 * 16, cudaMemcpyHostToDevice));
    gpuErrchk(cudaMemcpy(dev_D, host_D.data(), sizeof(float) * 16 * 16, cudaMemcpyHostToDevice));

    // perform computation on GPU
    tensor_16x16_kernel<<<1, 32>>>(dev_A, dev_B, dev_C, dev_D);

    gpuErrchk(cudaDeviceSynchronize());
    gpuErrchk(cudaPeekAtLastError());

    // copy results from GPU memory
    gpuErrchk(cudaMemcpy(host_D.data(), dev_D, sizeof(float) * 16 * 16, cudaMemcpyDeviceToHost));

    // deallocate GPU memory
    gpuErrchk(cudaFree(dev_A));
    gpuErrchk(cudaFree(dev_B));
    gpuErrchk(cudaFree(dev_C));
    gpuErrchk(cudaFree(dev_D));

    // check the results
    float *check_D = (float *) malloc(sizeof(float) * 16 * 16);
    for (int i=0; i<16; i++) {
        for (int j=0; j<16; j++) {
            float tmp = 0;
            for (int k=0; k<16; k++) {
                tmp += __half2float(host_A[i * 16 + k] * host_B[k * 16 + j]);
            }
            check_D[i * 16 + j] = tmp + host_C[i * 16 + j];
        }
    }
    for (int i=0; i<16*16; i++) {
        float diff = std::abs(check_D[i] - host_D[i]);
        if (diff > 0.5e-1) {
            std::cout << "Result error!" << std::endl;
            std::cout << "check_D[i]: " << check_D[i] << " != host_D[i]: " << host_D[i] << std::endl;
        }
    }
    std::cout << "Result is ok!" << std::endl;

    // ceallocate host memory
    free(check_D);

    return 0;
}
